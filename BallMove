using System.Collections;
using System.Collections.Generic;
using UnityEngine;
using UnityEngine.SceneManagement;
using UnityEngine.UI;

public class BallMove : MonoBehaviour
{
    public float speed; //처음 속도
    public float maxspeed; // 최대 속도 제한
    public float acceleration; // 초당 증가할 속도
    public AudioClip backgroundMusic; // 배경음 파일
    public GameObject gameOverPanel; 
    private bool movingRight = true;
    private bool isDead = false;

    public AudioClip itemSource; // 아이템을 먹었을때 재생할 소리
    public AudioClip gameOverSorce; // 게임 오버 시 재생할 소리

    private bool isGameStart = false; // 게임 시작 여부

    private Rigidbody rb;

    public float rotationBall = 500f; //공의 회전 속도

    public Text scoreText; // 연결할 점수 Text
    public int score; //점수

    void Start()
    {
        rb = GetComponent<Rigidbody>();
        UpdateScoreUI(); // 시작할 때 점수 초기화
       
    }

    void Update()
    {
        if (!isGameStart)
        {
            if (Input.GetMouseButtonDown(0))
            {
                isGameStart = true;
                //클릭하면 공이 움직이도록 함

                if (SoundManager.instance != null && backgroundMusic != null)
                {
                    SoundManager.instance.BgmBackground(backgroundMusic);
                }
                return;
            }
            return;
        }
        
        //매 프레임 마다 조금씩 속도 증가
        if(speed < maxspeed)
        {
            speed += acceleration * Time.deltaTime;
        }
        
        //죽었으면 실행 중지
        if (isDead) return;


        if (Input.GetMouseButtonDown(0))
        {
            movingRight = !movingRight;
        }

        //이동 및 공 추락 체크
        Move();
        CheckFall();
    }

    void Move()
    {
        Vector3 direction = movingRight ? Vector3.right : Vector3.forward;
        transform.position += direction * speed * Time.deltaTime;

        Vector3 rotationAxis = new Vector3(direction.z, 0, -direction.x);
        transform.Rotate(rotationAxis, rotationBall * Time.deltaTime, Space.World);

    }

    void CheckFall()
    {
        if (transform.position.y < -2f && !isDead)
        {
            GameOver();
        }
    }

    void GameOver()
    {
        isDead = true;
        // 게임 오버 소리
        if(SoundManager.instance != null && gameOverSorce != null)
        {
            SoundManager.instance.PlayGameOverSound(gameOverSorce);
        }
  
        // 게임 오버 UI
        if (gameOverPanel != null)
        {
            gameOverPanel.SetActive(true);
        }
    }

    // 버튼을 눌렀을 때 실행될 함수
    public void RestartGame()
    {
        if(SoundManager.instance != null)
        {
            SoundManager.instance.StopGameOverSound();
        }
        // 현재 열려 있는 씬을 다시 로드
        SceneManager.LoadScene(SceneManager.GetActiveScene().name);
    }

    private void OnCollisionExit(Collision collision)
    {
        if (collision.gameObject.CompareTag("Floor"))
        {
            FindObjectOfType<PathSpawner>().SpawnFloor();
        }
    }

    private void OnTriggerEnter(Collider other)
    {
        //충돌한 오브젝트의 태그가 "Item"인지 확인
        if (other.gameObject.CompareTag("Item"))
        {
            SoundManager.instance.PlaySource(itemSource);
            Destroy(other.gameObject);
            score += 5; // 충돌할때마다 5점 추가
            UpdateScoreUI(); // 화면 점수

        }
    }

    void UpdateScoreUI()
    {
        if (scoreText != null)
        {
            scoreText.text = "Score :" + score;
        }
    }
}
